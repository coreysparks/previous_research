library(tidyverse)
library(sf)
#writePolyShape(usdat, "/Volumes/demography/users/ozd504/Work/Papers_Manuscripts/InfantMortManuscript/bayesuscounty.shp")
usdat<-st_read("bayesuscounty.shp")
usdat<-st_crs(7149)
?st_crs
class(usdat)
#writePolyShape(usdat, "/Volumes/demography/users/ozd504/Work/Papers_Manuscripts/InfantMortManuscript/bayesuscounty.shp")
usdat<-st_read("bayesuscounty.shp")
usdat<-st_geometry(usdat)<-NULL
#writePolyShape(usdat, "/Volumes/demography/users/ozd504/Work/Papers_Manuscripts/InfantMortManuscript/bayesuscounty.shp")
usdat<-st_read("bayesuscounty.shp")
st_geometry(usdat)<-NULL
cos<-tigris::counties()
head(cos)
head(usdat)
usdat<-left_join(usdat, cos, by=c("COFIPS"="GEOID"))
usdat<-st_transform(crs = 2163)
#writePolyShape(usdat, "/Volumes/demography/users/ozd504/Work/Papers_Manuscripts/InfantMortManuscript/bayesuscounty.shp")
usdat<-st_read("bayesuscounty.shp")
st_geometry(usdat)<-NULL
usdat<-left_join(usdat, cos, by=c("COFIPS"="GEOID"))
class(usdat)
class(cos)
#writePolyShape(usdat, "/Volumes/demography/users/ozd504/Work/Papers_Manuscripts/InfantMortManuscript/bayesuscounty.shp")
usdat<-st_read("bayesuscounty.shp")
usdat<-left_join(cos, usdat, by=c("GEOID" = "COFIPS"))
st_geometry(usdat)<-NULL
usdat<-left_join(cos, usdat, by=c("GEOID" = "COFIPS"))
class(usdat)
usdat<-st_transform(crs = 2163)
usdat<-st_transform(usdat, crs = 2163)
usdat%>%
ggplot()+
geom_sf(aes(fill= UNEMP))
usdat%>%
ggplot()+
geom_sf(aes(fill= UNEMP, color=UNEMP))
us.nb<-poly2nb(usdat, queen=T)
names(usdat)
us.wtw<-nb2listw(us.nb, zero.policy=T)
us.wb<-nb2WB(us.nb)
names(usdat)
#make variables
usdat$infd03<-usdat$f1194803
usdat$infd98<-usdat$f1194898
usdat$births03<-usdat$f1254603
usdat$births98<-usdat$f1254698
usdat$unempz<-as.numeric(scale(usdat$UNEMP, center=T, scale=T))
usdat$zblack<-as.numeric(scale(usdat$PBLACK, center=T, scale=T))
usdat$z_femkid<-as.numeric(scale(usdat$pfemhhwkid, center=T, scale=T))
usdat$z_pubass<-as.numeric(scale(usdat$phhpubas_1, center=T, scale=T))
usdat$ne_bad<-usdat$povz+usdat$unempz+usdat$z_femkid+usdat$z_pubass
#NE_good
usdat$z_hiwork<-as.numeric(scale(usdat$pmgmtprofo, center=T, scale=T))
usdat$z_hiedu<-as.numeric(scale(usdat$p25pluspro, center=T, scale=T))
usdat$z_inc<-as.numeric(scale(usdat$MEDHHINC, center=T, scale=T))
usdat$ne_good<-usdat$z_hiedu+usdat$z_inc+usdat$z_hiwork
usdat$ne_bad<-(usdat$povz+usdat$unempz+usdat$z_femkid+usdat$z_pubass+usdat$z_inc+usdat$z_hiedu+usdat$z_hiwork)/7
#Form poisson expected
usdat$E<-usdat$births03*(sum(usdat$infd03)/sum(usdat$births03))
usdat$smr03<-usdat$infd03/usdat$E
#descriptive spatial
tid<-moran.mc(usdat$infd03, listw=us.wtw, zero.policy=T,  nsim=999 )
tsmr<-moran.mc(usdat$smr, listw=us.wtw, zero.policy=T,  nsim=999 )
t1<-moran.mc(usdat$PRURAL2K, listw=us.wtw, zero.policy=T,  nsim=999 )
t2<-moran.mc(usdat$giniz, listw=us.wtw, zero.policy=T,  nsim=999 )
t3<-moran.mc(usdat$ne_bad, listw=us.wtw, zero.policy=T,  nsim=999 )
t4<-moran.mc(usdat$DISSWB, listw=us.wtw, zero.policy=T, nsim=999 )
t5<-moran.mc(usdat$DISSPR, listw=us.wtw, zero.policy=T, nsim=999 )
t6<-moran.mc(usdat$ISOBW, listw=us.wtw, zero.policy=T, nsim=999 )
t7<-moran.mc(usdat$ISOPR, listw=us.wtw, zero.policy=T, nsim=999 )
t8<-moran.mc(usdat$SPSEGR, listw=us.wtw, zero.policy=T, nsim=999 )
t9<-moran.mc(usdat$SPSEGP, listw=us.wtw, zero.policy=T, nsim=999 )
mean(usdat@data[,c("infd03", "E", "smr03","GINI00", "PRURAL2K", "ne_bad")], na.rm=T);sd(usdat@data[,c("infd03", "E","smr03", "GINI00", "PRURAL2K", "ne_bad")], na.rm=T)
mean(usdat@data[,c("DISSWB", "DISSPR", "ISOBW", "ISOPR", "SPSEGR", "SPSEGP")]);sd(usdat@data[,c("DISSWB", "DISSPR", "ISOBW", "ISOPR", "SPSEGR", "SPSEGP")])
desdatdf<-list(controls=data.frame(meanscontrols=mean(usdat@data[,c("infd03", "E", "smr03","GINI00", "PRURAL2K", "ne_bad")], na.rm=T),
sdcontrols=sd(usdat@data[,c("infd03", "E","smr03", "GINI00", "PRURAL2K", "ne_bad")], na.rm=T)),
seg=data.frame(meanseg=mean(usdat@data[,c("DISSWB", "DISSPR", "ISOBW", "ISOPR", "SPSEGR", "SPSEGP")]),
sdseg=sd(usdat@data[,c("DISSWB", "DISSPR", "ISOBW", "ISOPR", "SPSEGR", "SPSEGP")])),
moran.stats<-data.frame(infd=tid$statistic, smr=tsmr$statistic,rural=t1$statistic,gini=t2$statistic,depr=t3$statistic,
disbw=t4$statistic,dispr=t5$statistic,isobw=t6$statistic,isopr=t7$statistic,
spbw=t8$statistic,sppr=t9$statistic))
library(spdep)
tid<-moran.mc(usdat$infd03, listw=us.wtw, zero.policy=T,  nsim=999 )
tsmr<-moran.mc(usdat$smr, listw=us.wtw, zero.policy=T,  nsim=999 )
t1<-moran.mc(usdat$PRURAL2K, listw=us.wtw, zero.policy=T,  nsim=999 )
t2<-moran.mc(usdat$giniz, listw=us.wtw, zero.policy=T,  nsim=999 )
t3<-moran.mc(usdat$ne_bad, listw=us.wtw, zero.policy=T,  nsim=999 )
t4<-moran.mc(usdat$DISSWB, listw=us.wtw, zero.policy=T, nsim=999 )
t5<-moran.mc(usdat$DISSPR, listw=us.wtw, zero.policy=T, nsim=999 )
t6<-moran.mc(usdat$ISOBW, listw=us.wtw, zero.policy=T, nsim=999 )
t7<-moran.mc(usdat$ISOPR, listw=us.wtw, zero.policy=T, nsim=999 )
t8<-moran.mc(usdat$SPSEGR, listw=us.wtw, zero.policy=T, nsim=999 )
t9<-moran.mc(usdat$SPSEGP, listw=us.wtw, zero.policy=T, nsim=999 )
us.nb<-poly2nb(usdat, queen=T)
names(usdat)
us.wtw<-nb2listw(us.nb, zero.policy=T)
us.wb<-nb2WB(us.nb)
#descriptive spatial
tid<-moran.mc(usdat$infd03, listw=us.wtw, zero.policy=T,  nsim=999 )
tsmr<-moran.mc(usdat$smr, listw=us.wtw, zero.policy=T,  nsim=999 )
t1<-moran.mc(usdat$PRURAL2K, listw=us.wtw, zero.policy=T,  nsim=999 )
t2<-moran.mc(usdat$giniz, listw=us.wtw, zero.policy=T,  nsim=999 )
t3<-moran.mc(usdat$ne_bad, listw=us.wtw, zero.policy=T,  nsim=999 )
t4<-moran.mc(usdat$DISSWB, listw=us.wtw, zero.policy=T, nsim=999 )
t5<-moran.mc(usdat$DISSPR, listw=us.wtw, zero.policy=T, nsim=999 )
t6<-moran.mc(usdat$ISOBW, listw=us.wtw, zero.policy=T, nsim=999 )
t7<-moran.mc(usdat$ISOPR, listw=us.wtw, zero.policy=T, nsim=999 )
t8<-moran.mc(usdat$SPSEGR, listw=us.wtw, zero.policy=T, nsim=999 )
t9<-moran.mc(usdat$SPSEGP, listw=us.wtw, zero.policy=T, nsim=999 )
t1<-moran.mc(usdat$PRURAL2K, listw=us.wtw, zero.policy=T, na.action = "na.omit", nsim=999 )
usdat<-usdat%>%
filter(complete.cases(f1194803, f1254603))
us.nb<-poly2nb(usdat, queen=T)
names(usdat)
us.wtw<-nb2listw(us.nb, zero.policy=T)
us.wb<-nb2WB(us.nb)
#make variables
usdat$infd03<-usdat$f1194803
usdat$infd98<-usdat$f1194898
usdat$births03<-usdat$f1254603
usdat$births98<-usdat$f1254698
usdat$unempz<-as.numeric(scale(usdat$UNEMP, center=T, scale=T))
usdat$zblack<-as.numeric(scale(usdat$PBLACK, center=T, scale=T))
usdat$z_femkid<-as.numeric(scale(usdat$pfemhhwkid, center=T, scale=T))
usdat$z_pubass<-as.numeric(scale(usdat$phhpubas_1, center=T, scale=T))
usdat$ne_bad<-usdat$povz+usdat$unempz+usdat$z_femkid+usdat$z_pubass
#NE_good
usdat$z_hiwork<-as.numeric(scale(usdat$pmgmtprofo, center=T, scale=T))
usdat$z_hiedu<-as.numeric(scale(usdat$p25pluspro, center=T, scale=T))
usdat$z_inc<-as.numeric(scale(usdat$MEDHHINC, center=T, scale=T))
usdat$ne_good<-usdat$z_hiedu+usdat$z_inc+usdat$z_hiwork
usdat$ne_bad<-(usdat$povz+usdat$unempz+usdat$z_femkid+usdat$z_pubass+usdat$z_inc+usdat$z_hiedu+usdat$z_hiwork)/7
#Form poisson expected
usdat$E<-usdat$births03*(sum(usdat$infd03)/sum(usdat$births03))
usdat$smr03<-usdat$infd03/usdat$E
#descriptive spatial
tid<-moran.mc(usdat$infd03, listw=us.wtw, zero.policy=T,  nsim=999 )
tsmr<-moran.mc(usdat$smr, listw=us.wtw, zero.policy=T,  nsim=999 )
t1<-moran.mc(usdat$PRURAL2K, listw=us.wtw, zero.policy=T, nsim=999 )
t2<-moran.mc(usdat$giniz, listw=us.wtw, zero.policy=T,  nsim=999 )
t3<-moran.mc(usdat$ne_bad, listw=us.wtw, zero.policy=T,  nsim=999 )
t4<-moran.mc(usdat$DISSWB, listw=us.wtw, zero.policy=T, nsim=999 )
t5<-moran.mc(usdat$DISSPR, listw=us.wtw, zero.policy=T, nsim=999 )
t6<-moran.mc(usdat$ISOBW, listw=us.wtw, zero.policy=T, nsim=999 )
t7<-moran.mc(usdat$ISOPR, listw=us.wtw, zero.policy=T, nsim=999 )
t8<-moran.mc(usdat$SPSEGR, listw=us.wtw, zero.policy=T, nsim=999 )
t9<-moran.mc(usdat$SPSEGP, listw=us.wtw, zero.policy=T, nsim=999 )
mean(usdat@data[,c("infd03", "E", "smr03","GINI00", "PRURAL2K", "ne_bad")], na.rm=T);sd(usdat@data[,c("infd03", "E","smr03", "GINI00", "PRURAL2K", "ne_bad")], na.rm=T)
mean(usdat@data[,c("DISSWB", "DISSPR", "ISOBW", "ISOPR", "SPSEGR", "SPSEGP")]);sd(usdat@data[,c("DISSWB", "DISSPR", "ISOBW", "ISOPR", "SPSEGR", "SPSEGP")])
desdatdf<-list(controls=data.frame(meanscontrols=mean(usdat@data[,c("infd03", "E", "smr03","GINI00", "PRURAL2K", "ne_bad")], na.rm=T),
sdcontrols=sd(usdat@data[,c("infd03", "E","smr03", "GINI00", "PRURAL2K", "ne_bad")], na.rm=T)),
seg=data.frame(meanseg=mean(usdat@data[,c("DISSWB", "DISSPR", "ISOBW", "ISOPR", "SPSEGR", "SPSEGP")]),
sdseg=sd(usdat@data[,c("DISSWB", "DISSPR", "ISOBW", "ISOPR", "SPSEGR", "SPSEGP")])),
moran.stats<-data.frame(infd=tid$statistic, smr=tsmr$statistic,rural=t1$statistic,gini=t2$statistic,depr=t3$statistic,
disbw=t4$statistic,dispr=t5$statistic,isobw=t6$statistic,isopr=t7$statistic,
spbw=t8$statistic,sppr=t9$statistic))
desdatdf
usdat$gt1d<-ifelse(usdat$infd03>=1,1,0)
usdat$gt200bl<-ifelse((usdat$PBLACK*usdat$f0453000)>=200,1,0 )
usdat$bgt10<-ifelse(usdat$births03>=10,1,0)
usdat$lcismr<-(qchisq(p=.95,df=2*usdat$infd03,log.p=F, lower.tail=F)*.5 )/usdat$E
usdat$ucismr<-(qchisq(p=.05,df=2*usdat$infd03+1,log.p=F, lower.tail=F)*.5 )/usdat$E
usdat$smrgt1<-ifelse(usdat$ucismr>1&usdat$lcismr>1,1,0)
spplot(usdat, "smrgt1")
usdat$disswbz<-as.numeric(scale(usdat$DISSWB, center=T, scale=T))
usdat$disspz<-as.numeric(scale(usdat$DISSPR, center=T, scale=T))
usdat$isowbz<-as.numeric(scale(usdat$ISOBW, center=T, scale=T))
usdat$isoprz<-as.numeric(scale(usdat$ISOPR, center=T, scale=T))
usdat$spbwz<-as.numeric(scale(usdat$SPSEGR, center=T, scale=T))
usdat$spprz<-as.numeric(scale(usdat$SPSEGP, center=T, scale=T))
desdatdf<-list(controls=data.frame(meanscontrols=mean(usdat@data[,c("infd03", "E", "smr03","GINI00", "PRURAL2K", "ne_bad")], na.rm=T),
sdcontrols=sd(usdat@data[,c("infd03", "E","smr03", "GINI00", "PRURAL2K", "ne_bad")], na.rm=T)),
seg=data.frame(meanseg=mean(usdat@data[,c("DISSWB", "DISSPR", "ISOBW", "ISOPR", "SPSEGR", "SPSEGP")]),
sdseg=sd(usdat@data[,c("DISSWB", "DISSPR", "ISOBW", "ISOPR", "SPSEGR", "SPSEGP")])),
moran.stats<-data.frame(infd=tid$statistic, smr=tsmr$statistic,rural=t1$statistic,gini=t2$statistic,depr=t3$statistic,
disbw=t4$statistic,dispr=t5$statistic,isobw=t6$statistic,isopr=t7$statistic,
spbw=t8$statistic,sppr=t9$statistic))
#poisson regressions
fit.0<-glm(infd03~offset(log(E+.000001))+giniz+PRURAL2K+DISSWB+ne_bad, family=quasipoisson, data=usdat)
fit.1<-glm(infd03~offset(log(E+.000001))+giniz+PRURAL2K+DISSPR+ne_bad, family=quasipoisson, data=usdat)
fit.2<-glm(infd03~offset(log(E+.000001))+giniz+PRURAL2K+ISOBW+ne_bad, family=quasipoisson, data=usdat)
fit.3<-glm(infd03~offset(log(E+.000001))+giniz+PRURAL2K+ISOPR+ne_bad, family=quasipoisson, data=usdat)
fit.4<-glm(infd03~offset(log(E+.000001))+giniz+PRURAL2K+SPSEGR+ne_bad, family=quasipoisson, data=usdat, subset=SPSEGR>0)
fit.5<-glm(infd03~offset(log(E+.000001))+giniz+PRURAL2K+SPSEGP+ne_bad, family=quasipoisson, data=usdat)
fit0<-glm(infd03~offset(log(E+.000001))+DISSWB, family=poisson, data=usdat)
fit.0<-glm(infd03~offset(log(E+.000001))+DISSPR, family=poisson, data=usdat)
fit.1<-glm(infd03~offset(log(E+.000001))+ISOBW, family=poisson, data=usdat)
fit.2<-glm(infd03~offset(log(E+.000001))+ISOPR, family=poisson, data=usdat)
fit.3<-glm(infd03~offset(log(E+.000001))+SPSEGR, family=poisson, data=usdat)
fit.4<-glm(infd03~offset(log(E+.000001))+SPSEGP, family=poisson, data=usdat)
AIC(fit.0);AIC(fit.1); AIC(fit.2); AIC(fit.3); AIC(fit.4); AIC (fit.5)
